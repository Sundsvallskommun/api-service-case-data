package se.sundsvall.casedata.integration.landandexploitation;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.assertThatThrownBy;
import static org.mockito.Mockito.verify;
import static org.mockito.Mockito.when;
import static org.zalando.problem.Status.SERVICE_UNAVAILABLE;
import static se.sundsvall.casedata.TestUtil.createErrandEntity;

import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.zalando.problem.AbstractThrowableProblem;
import org.zalando.problem.Problem;

import generated.se.sundsvall.parkingpermit.StartProcessResponse;

@ExtendWith(MockitoExtension.class)
class LandAndExploitationIntegrationTest {

	@Mock
	private LandAndExploitationClient landAndExploitationClient;

	@InjectMocks
	private LandAndExploitationIntegration landAndExploitationIntegration;

	@Test
	void startProcessTest() {
		final var errand = createErrandEntity();
		final var response = new StartProcessResponse();
		when(landAndExploitationClient.startProcess(errand.getMunicipalityId(), errand.getId())).thenReturn(response);

		final var result = landAndExploitationIntegration.startProcess(errand);

		assertThat(result).isEqualTo(response);
		verify(landAndExploitationClient).startProcess(errand.getMunicipalityId(), errand.getId());
	}

	@Test
	void startProcess_whenThrowsTest() {
		final var errand = createErrandEntity();
		when(landAndExploitationClient.startProcess(errand.getMunicipalityId(), errand.getId())).thenThrow(new AbstractThrowableProblem() {

			private static final long serialVersionUID = 1L;
		});

		assertThatThrownBy(() -> landAndExploitationIntegration.startProcess(errand))
			.isInstanceOf(Problem.class)
			.hasMessage("Service Unavailable: Unexpected response from ProcessEngine API.")
			.hasFieldOrPropertyWithValue("status", SERVICE_UNAVAILABLE);

		verify(landAndExploitationClient).startProcess(errand.getMunicipalityId(), errand.getId());
	}

	@Test
	void updateProcessTest() {
		final var errand = createErrandEntity();
		landAndExploitationIntegration.updateProcess(errand);

		verify(landAndExploitationClient).updateProcess(errand.getMunicipalityId(), errand.getProcessId());
	}

	@Test
	void updateProcess_whenThrowsTest() {
		final var errand = createErrandEntity();
		when(landAndExploitationClient.updateProcess(errand.getMunicipalityId(), errand.getProcessId())).thenThrow(new AbstractThrowableProblem() {

			private static final long serialVersionUID = 1L;
		});

		assertThatThrownBy(() -> landAndExploitationIntegration.updateProcess(errand))
			.isInstanceOf(Problem.class)
			.hasMessage("Service Unavailable: Unexpected response from ProcessEngine API.")
			.hasFieldOrPropertyWithValue("status", SERVICE_UNAVAILABLE);

		verify(landAndExploitationClient).updateProcess(errand.getMunicipalityId(), errand.getProcessId());
	}

}
